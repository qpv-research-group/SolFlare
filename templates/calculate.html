{% load static %}

<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Efficiency Limit Calculator</title>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/Chart.js/3.7.0/chart.min.js"></script>
    <script src="https://code.jquery.com/jquery-3.6.0.min.js"></script>
    <script src="https://code.jquery.com/ui/1.12.1/jquery-ui.min.js"></script>
    <link rel="stylesheet" href="https://code.jquery.com/ui/1.12.1/themes/base/jquery-ui.css">
    <style>
        body { font-family: Arial, sans-serif; max-width: 800px; margin: 0 auto; padding: 20px; }
        .logo-container img { height: 50px; }
        #chart-container { position: relative; height: 400px; width: 100%; margin-top: 20px; }
        .bandgap-line { position: absolute; top: 0; bottom: 0; width: 4px; cursor: ew-resize; }
        .slider { width: 300px; margin: 10px 0; }
        #bandgap-values { margin-top: 10px; }
        .bandgap-value { display: inline-block; margin-right: 10px; padding: 5px; border-radius: 5px; }
        #results {
            position: absolute;
            top: 10px;
            right: 10px;
            background-color: rgba(255, 255, 255, 0.8);
            padding: 10px;
            border-radius: 5px;
            box-shadow: 0 0 10px rgba(0,0,0,0.1);
        }
        #results h2 { margin-top: 0; }
    </style>
</head>
<body>
    <div class="logo-container">
        <img src="{% static 'unswlogo.png' %}" alt="UNSW Logo">
        <a href="http://www.solcore.solar"><img src="{% static 'solcore.png' %}" alt="Solcore Logo"></a>
    </div>

    <h1>Efficiency Limit Calculator</h1>

    <p>The efficiency limit is calculated using the Shockley-Queisser model implemented in <a href="http://www.solcore.solar">Solcore</a>. Select the number of junctions and drag the colored lines to change the bandgaps and see how it affects the theoretical maximum efficiency of a multi-junction solar cell.</p>

    <form id="eg-form" method="post">
        {% csrf_token %}
        <label for="num_junctions">Number of Junctions:</label>
        <input type="number" id="num_junctions" name="num_junctions" min="1" max="10" value="1">
        <div id="bandgap-sliders"></div>
    </form>

    <div id="bandgap-values"></div>

    <div id="chart-container">
        <canvas id="spectrum-chart"></canvas>
        <div id="results">
            <h2>Results</h2>
            <p>Efficiency: <span id="efficiency">-</span>%</p>
            <p>V<sub>OC</sub>: <span id="voc">-</span> V</p>
            <p>J<sub>SC</sub>: <span id="jsc">-</span> mA/cm<sup>2</sup></p>
            <p>FF: <span id="ff">-</span>%</p>
        </div>
    </div>

<script>
    let chart;
    let bandgapLines = [];
    const colors = ['#FF4136', '#FF851B', '#FFDC00', '#2ECC40', '#0074D9', '#B10DC9', '#85144b', '#3D9970', '#39CCCC', '#01FF70'];

    function initializeChart(spectrumData) {
        const ctx = document.getElementById('spectrum-chart').getContext('2d');
        chart = new Chart(ctx, {
            type: 'line',
            data: {
                datasets: [{
                    label: '',
                    data: spectrumData,
                    borderColor: 'rgba(75, 192, 192, 0.8)',
                    backgroundColor: 'rgba(75, 192, 192, 0.2)',
                    fill: true,
                    pointRadius: 0  // Remove points from the line
                }]
            },
            options: {
                responsive: true,
                maintainAspectRatio: false,
                plugins: {
                legend: {
                    display: false // Hide the legend completely
                }
            },
                scales: {
                    x: {
                        type: 'linear',
                        position: 'bottom',
                        title: {
                            display: true,
                            text: 'Energy (eV)'
                        },
                        min: 0.25  // Start the x-axis at 0.25 eV
                    },
                    y: {
                        type: 'linear',
                        position: 'left',
                        title: {
                            display: true,
                            text: 'Photon Flux (m⁻² s⁻¹ eV⁻¹)'
                        }
                    }
                }
            }
        });
    }

    function updateBandgapLines() {
        const numJunctions = parseInt($('#num_junctions').val());
        const chartArea = chart.chartArea;
        const xScale = chart.scales.x;

        // Remove excess bandgap lines
        $('.bandgap-line').slice(numJunctions).remove();

        // Update or create bandgap lines
        for (let i = 1; i <= numJunctions; i++) {
            let egValue = parseFloat($(`#eg_value_${i}`).val()) || 1.0;
            const xPos = xScale.getPixelForValue(egValue);
            let line = $(`#bandgap-line-${i}`);

            if (line.length === 0) {
                line = $('<div>')
                    .addClass('bandgap-line')
                    .attr('id', `bandgap-line-${i}`)
                    .appendTo('#chart-container');
            }

            line.css({
                'left': `${xPos}px`,
                'background-color': colors[i - 1],
                'width': '4px'  // Increased line thickness
            });

            // Make the line draggable
            if (!line.hasClass('ui-draggable')) {
                line.draggable({
                    axis: 'x',
                    containment: '#chart-container',
                    drag: function(event, ui) {
                        const newEgValue = xScale.getValueForPixel(ui.position.left);
                        updateBandgapValue(i, newEgValue, false);
                    },
                    stop: function() {
                        const newEgValue = xScale.getValueForPixel($(this).position().left);
                        updateBandgapValue(i, newEgValue, true);
                        calculateEfficiency();
                    }
                });
            }
        }
    }

    function updateBandgapValue(index, value, updateSlider = true) {
        const roundedValue = Math.round(value * 100) / 100;
        $(`#eg_value_${index}`).val(roundedValue);
        $(`#eg_value_${index}_display`).text(roundedValue.toFixed(2));
        if (updateSlider) {
            $(`#slider_${index}`).slider('value', roundedValue);
        }
    }

function updateBandgapSliders() {
    const numJunctions = parseInt($('#num_junctions').val());
    const slidersContainer = $('#bandgap-sliders');
    const valuesContainer = $('#bandgap-values');

    // Remove excess sliders and value displays
    slidersContainer.children('.slider').slice(numJunctions).remove();
    valuesContainer.children('.bandgap-value').slice(numJunctions).remove();

    for (let i = 1; i <= numJunctions; i++) {
        const sliderId = `slider_${i}`;
        const inputId = `eg_value_${i}`;
        let sliderValue = $(`#${inputId}`);
        let slider = $(`#${sliderId}`);
        let valueDisplay = $(`#${inputId}_display`).parent();

        if (sliderValue.length === 0) {
            sliderValue = $(`<input type="hidden" id="${inputId}" name="${inputId}" value="1.0">`);
            slidersContainer.append(sliderValue);
        }

        if (slider.length === 0) {
            slider = $('<div>').addClass('slider').attr('id', sliderId);
            slidersContainer.append(slider);
        }

        if (valueDisplay.length === 0) {
            valueDisplay = $(`<div class="bandgap-value" style="background-color: ${colors[i - 1]}; color: white;">
                Bandgap ${i}: <span id="${inputId}_display">1.00</span> eV
                <br>J<sub>SC</sub>: <span id="jsc_junction_${i}">-</span> mA/cm<sup>2</sup>
            </div>`);
            valuesContainer.append(valueDisplay);
        }

        if (!slider.hasClass('ui-slider')) {
            slider.slider({
                min: 0.5,
                max: 4,
                step: 0.01,
                value: parseFloat(sliderValue.val()) || 1.0,
                slide: function(event, ui) {
                    updateBandgapValue(i, ui.value, false);
                },
                change: function(event, ui) {
                    if (event.originalEvent) {
                        updateBandgapValue(i, ui.value, true);
                        updateBandgapLines();
                        calculateEfficiency();
                    }
                }
            });
        }
    }
}

    function calculateEfficiency() {
        const formData = $('#eg-form').serialize();
        $.ajax({
            url: '{% url "calculate_efficiency" %}',
            type: 'POST',
            data: formData,
            success: function(response) {
                $('#efficiency').text(response.efficiency);
                $('#voc').text(response.voc);
                $('#jsc').text(response.jsc);
                $('#ff').text(response.ff);

                // Update jsc per junction
                response.jsc_per_junction.forEach((jsc, index) => {
                    $(`#jsc_junction_${index + 1}`).text(jsc.toFixed(1));
                });
            }
        });
    }

    $(document).ready(function() {
        initializeChart({{ spectrum_data|safe }});

        $('#num_junctions').on('change', function() {
            updateBandgapSliders();
            updateBandgapLines();
            calculateEfficiency();
        });

        updateBandgapSliders();
        updateBandgapLines();
        calculateEfficiency();
    });
</script>
</body>
</html>